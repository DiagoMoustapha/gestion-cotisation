<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Gestion des Cotisations</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Barre d'authentification -->
    <div id="auth-bar" class="auth-bar">
        <div class="container auth-content">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <span id="user-email">utilisateur@exemple.com</span>
                <span id="admin-badge" class="admin-badge">
                    <i class="fas fa-crown"></i> Administrateur
                </span>
            </div>
            <div>
                <button class="btn btn-sm btn-warning" id="backup-btn">
                    <i class="fas fa-download"></i>
                    Sauvegarder
                </button>
                <button class="btn btn-sm btn-danger" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    D√©connexion
                </button>
            </div>
        </div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-piggy-bank"></i>
                    Gestion des Cotisations
                </div>
                <nav>
                    <ul>
                        <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> Tableau de bord</a></li>
                        <li><a href="eleves.html"><i class="fas fa-users"></i> √âl√®ves</a></li>
                        <li><a href="cotisations.html"><i class="fas fa-hand-holding-usd"></i> Cotisations</a></li>
                        <li><a href="recherche.html"><i class="fas fa-search"></i> Recherche</a></li>
                        <li><a href="depenses.html"><i class="fas fa-receipt"></i> D√©penses</a></li>
                        <li><a href="resume.html"><i class="fas fa-chart-bar"></i> R√©sum√©</a></li>
                        <li><a href="admin.html" class="active"><i class="fas fa-cog"></i> Administration</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-cog"></i>
                    Administration
                </div>
            </div>
            
            <!-- Section Sauvegarde -->
            <div class="admin-section">
                <h3><i class="fas fa-database"></i> Gestion des sauvegardes</h3>
                <div class="backup-controls">
                    <button class="btn btn-primary" id="export-data">
                        <i class="fas fa-download"></i>
                        Exporter toutes les donn√©es
                    </button>
                    <button class="btn btn-warning" id="import-data">
                        <i class="fas fa-upload"></i>
                        Importer des donn√©es
                    </button>
                    <button class="btn btn-danger" id="clear-data">
                        <i class="fas fa-trash"></i>
                        Effacer toutes les donn√©es
                    </button>
                </div>
            </div>

            <!-- Section Utilisateurs -->
            <div class="admin-section">
                <h3><i class="fas fa-users-cog"></i> Gestion des utilisateurs</h3>
                <div class="backup-controls">
                    <button class="btn btn-admin" id="manage-users">
                        <i class="fas fa-user-shield"></i>
                        G√©rer les administrateurs
                    </button>
                    <button class="btn btn-warning" id="view-logs">
                        <i class="fas fa-history"></i>
                        Journal d'activit√©
                    </button>
                </div>
            </div>

            <!-- Section Statistiques -->
            <div class="admin-section">
                <h3><i class="fas fa-chart-line"></i> Statistiques avanc√©es</h3>
                <div class="backup-controls">
                    <button class="btn btn-secondary" id="generate-reports">
                        <i class="fas fa-file-pdf"></i>
                        G√©n√©rer rapport PDF
                    </button>
                    <button class="btn btn-primary" id="view-statistics">
                        <i class="fas fa-chart-bar"></i>
                        Statistiques d√©taill√©es
                    </button>
                </div>
            </div>

            <!-- Section Syst√®me -->
            <div class="admin-section">
                <h3><i class="fas fa-server"></i> Informations syst√®me</h3>
                <div id="system-info" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <div class="summary-item">
                        <span>Version de l'application:</span>
                        <span>2.0.0</span>
                    </div>
                    <div class="summary-item">
                        <span>Base de donn√©es:</span>
                        <span id="db-status">Firebase Firestore</span>
                    </div>
                    <div class="summary-item">
                        <span>Nombre total d'√©l√®ves:</span>
                        <span id="total-students">0</span>
                    </div>
                    <div class="summary-item">
                        <span>Nombre total de cotisations:</span>
                        <span id="total-contributions-count">0</span>
                    </div>
                    <div class="summary-item">
                        <span>Derni√®re sauvegarde:</span>
                        <span id="last-backup">Jamais</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de gestion des utilisateurs -->
    <div id="users-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-shield"></i> Gestion des administrateurs</h2>
                <span class="close">&times;</span>
            </div>
            <div class="form-group">
                <label>Ajouter un administrateur</label>
                <input type="email" id="new-admin-email" placeholder="nouvel@admin.com">
                <button class="btn btn-admin" id="add-admin" style="margin-top: 10px; width: 100%;">
                    <i class="fas fa-plus"></i>
                    Ajouter comme administrateur
                </button>
            </div>
            <div id="admins-list">
                <!-- Liste des administrateurs -->
            </div>
        </div>
    </div>

    <!-- Modal d'import de donn√©es -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-upload"></i> Importer des donn√©es</h2>
                <span class="close">&times;</span>
            </div>
            <div class="form-group">
                <label>S√©lectionnez un fichier de sauvegarde (.json)</label>
                <input type="file" id="import-file" accept=".json">
                <p style="font-size: 12px; color: var(--gray); margin-top: 5px;">
                    Format attendu: fichier JSON export√© depuis cette application
                </p>
            </div>
            <button class="btn btn-primary" id="confirm-import" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-upload"></i>
                Importer les donn√©es
            </button>
        </div>
    </div>

    <script src="js/firebase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/functions.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // V√©rifier l'authentification et les droits admin
            await requireAuth();
            if (!isAdmin) {
                showNotification('Acc√®s r√©serv√© aux administrateurs', 'error');
                window.location.href = 'index.html';
                return;
            }
            
            // Charger les donn√©es syst√®me
            await loadSystemInfo();
            
            // √âv√©nements
            document.getElementById('export-data').addEventListener('click', exportAllData);
            document.getElementById('import-data').addEventListener('click', () => {
                document.getElementById('import-modal').style.display = 'flex';
            });
            document.getElementById('clear-data').addEventListener('click', clearAllData);
            document.getElementById('manage-users').addEventListener('click', openUsersManagement);
            document.getElementById('generate-reports').addEventListener('click', generatePDFReport);
            document.getElementById('view-statistics').addEventListener('click', viewDetailedStatistics);
            document.getElementById('view-logs').addEventListener('click', viewActivityLogs);
            document.getElementById('add-admin').addEventListener('click', addNewAdmin);
            document.getElementById('confirm-import').addEventListener('click', importData);
            
            // Fermer les modals
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        });
        
        // Charger les informations syst√®me
        async function loadSystemInfo() {
            await loadStudents();
            await loadContributions();
            await loadExpenses();
            
            document.getElementById('total-students').textContent = students.length;
            document.getElementById('total-contributions-count').textContent = contributions.length;
        }
        
        // Exporter toutes les donn√©es
        async function exportAllData() {
            try {
                const [studentsSnapshot, contributionsSnapshot, expensesSnapshot] = await Promise.all([
                    db.collection('students').get(),
                    db.collection('contributions').get(),
                    db.collection('expenses').get()
                ]);
                
                const data = {
                    students: studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    contributions: contributionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    expenses: expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    exportDate: new Date().toISOString(),
                    version: '2.0.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sauvegarde-cotisations-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                // Mettre √† jour la date de derni√®re sauvegarde
                document.getElementById('last-backup').textContent = new Date().toLocaleDateString('fr-FR');
                
                showNotification('Sauvegarde export√©e avec succ√®s', 'success');
            } catch (error) {
                console.error('Erreur export:', error);
                showNotification('Erreur lors de l\'export: ' + error.message, 'error');
            }
        }
        
        // Importer des donn√©es
        async function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Veuillez s√©lectionner un fichier', 'error');
                return;
            }
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (!data.students || !data.contributions || !data.expenses) {
                    throw new Error('Format de fichier invalide');
                }
                
                if (!confirm(`√ätes-vous s√ªr de vouloir importer ${data.students.length} √©l√®ves, ${data.contributions.length} cotisations et ${data.expenses.length} d√©penses ?`)) {
                    return;
                }
                
                showNotification('Import en cours...', 'warning');
                
                // Importer les √©l√®ves
                const studentPromises = data.students.map(student => 
                    db.collection('students').doc(student.id).set(student)
                );
                
                // Importer les cotisations
                const contributionPromises = data.contributions.map(contribution =>
                    db.collection('contributions').doc(contribution.id).set(contribution)
                );
                
                // Importer les d√©penses
                const expensePromises = data.expenses.map(expense =>
                    db.collection('expenses').doc(expense.id).set(expense)
                );
                
                await Promise.all([...studentPromises, ...contributionPromises, ...expensePromises]);
                
                document.getElementById('import-modal').style.display = 'none';
                fileInput.value = '';
                
                showNotification('Donn√©es import√©es avec succ√®s', 'success');
                setTimeout(() => location.reload(), 2000);
                
            } catch (error) {
                console.error('Erreur import:', error);
                showNotification('Erreur lors de l\'import: ' + error.message, 'error');
            }
        }
        
        // Effacer toutes les donn√©es
        async function clearAllData() {
            if (!confirm('üö® ATTENTION ! Cette action est irr√©versible.\n\n√ätes-vous ABSOLUMENT s√ªr de vouloir effacer TOUTES les donn√©es ?')) {
                return;
            }
            
            if (!confirm('‚ùå DERNIER AVERTISSEMENT !\n\nTous les √©l√®ves, cotisations et d√©penses seront d√©finitivement supprim√©s.')) {
                return;
            }
            
            try {
                showNotification('Suppression en cours...', 'warning');
                
                // Supprimer toutes les collections
                const collections = ['students', 'contributions', 'expenses'];
                const deletePromises = collections.map(async (collection) => {
                    const snapshot = await db.collection(collection).get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    return batch.commit();
                });
                
                await Promise.all(deletePromises);
                
                showNotification('Toutes les donn√©es ont √©t√© effac√©es', 'success');
                setTimeout(() => location.reload(), 2000);
                
            } catch (error) {
                console.error('Erreur suppression:', error);
                showNotification('Erreur lors de la suppression: ' + error.message, 'error');
            }
        }
        
        // Ouvrir la gestion des utilisateurs
        async function openUsersManagement() {
            await loadAdminsList();
            document.getElementById('users-modal').style.display = 'flex';
        }
        
        // Charger la liste des administrateurs
        async function loadAdminsList() {
            try {
                const snapshot = await db.collection('admins').get();
                const adminsList = document.getElementById('admins-list');
                adminsList.innerHTML = '<h3 style="margin: 20px 0 10px 0;">Administrateurs actuels</h3>';
                
                snapshot.forEach(doc => {
                    const admin = doc.data();
                    const adminElement = document.createElement('div');
                    adminElement.className = 'admin-item';
                    adminElement.style.padding = '10px';
                    adminElement.style.border = '1px solid #eee';
                    adminElement.style.marginBottom = '5px';
                    adminElement.style.borderRadius = '5px';
                    adminElement.innerHTML = `
                        <strong>${admin.email}</strong>
                        ${doc.id !== currentUser.uid ? 
                            `<button class="btn btn-danger btn-sm" onclick="removeAdmin('${doc.id}')" style="float: right;">
                                <i class="fas fa-trash"></i> Retirer
                            </button>` : 
                            '<span style="float: right; color: var(--gray);">(Vous)</span>'
                        }
                    `;
                    adminsList.appendChild(adminElement);
                });
            } catch (error) {
                console.error('Erreur chargement admins:', error);
            }
        }
        
        // Ajouter un nouvel administrateur
        async function addNewAdmin() {
            const email = document.getElementById('new-admin-email').value;
            
            if (!email) {
                showNotification('Veuillez entrer un email', 'error');
                return;
            }
            
            try {
                // V√©rifier si l'utilisateur existe dans Firebase Auth
                // Note: Cette fonctionnalit√© n√©cessite Firebase Admin SDK c√¥t√© serveur
                // Pour l'instant, nous cr√©ons simplement le document admin
                
                await db.collection('admins').doc().set({
                    email: email,
                    addedBy: currentUser.email,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    pending: true
                });
                
                showNotification('Administrateur ajout√© avec succ√®s', 'success');
                document.getElementById('new-admin-email').value = '';
                await loadAdminsList();
                
            } catch (error) {
                console.error('Erreur ajout admin:', error);
                showNotification('Erreur lors de l\'ajout: ' + error.message, 'error');
            }
        }
        
        // Retirer un administrateur
        async function removeAdmin(adminId) {
            if (!confirm('Retirer les droits administrateur de cet utilisateur ?')) {
                return;
            }
            
            try {
                await db.collection('admins').doc(adminId).delete();
                showNotification('Administrateur retir√©', 'success');
                await loadAdminsList();
            } catch (error) {
                console.error('Erreur retrait admin:', error);
                showNotification('Erreur lors du retrait: ' + error.message, 'error');
            }
        }
        
        // G√©n√©rer un rapport PDF (fonction de base)
        function generatePDFReport() {
            showNotification('G√©n√©ration du rapport PDF...', 'warning');
            // Impl√©mentation basique - pourrait √™tre √©tendue avec une librairie PDF
            const data = {
                date: new Date().toLocaleDateString('fr-FR'),
                totalStudents: students.length,
                totalContributions: contributions.length,
                totalExpenses: expenses.length,
                balance: contributions.reduce((sum, c) => sum + c.amount, 0) - expenses.reduce((sum, e) => sum + e.amount, 0)
            };
            
            const content = `
                RAPPORT DES COTISATIONS - ${data.date}
                =================================
                
                Statistiques g√©n√©rales:
                - Nombre d'√©l√®ves: ${data.totalStudents}
                - Nombre de cotisations: ${data.totalContributions}
                - Nombre de d√©penses: ${data.totalExpenses}
                - Solde disponible: ${formatCurrency(data.balance)}
                
                G√©n√©r√© le ${data.date}
            `;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rapport-cotisations-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Rapport g√©n√©r√© avec succ√®s', 'success');
        }
        
        // Voir les statistiques d√©taill√©es
        function viewDetailedStatistics() {
            window.location.href = 'resume.html';
        }
        
        // Voir le journal d'activit√©
        function viewActivityLogs() {
            showNotification('Journal d\'activit√© - Fonctionnalit√© √† venir', 'warning');
        }
    </script>

    <style>
        .admin-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 4px solid var(--admin);
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .admin-section h3 {
            color: var(--admin);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .backup-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .backup-controls {
                flex-direction: column;
            }
            
            .backup-controls .btn {
                width: 100%;
            }
        }
    </style>
</body>
</html>