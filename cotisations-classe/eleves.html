<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des √âl√®ves - Cotisations</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Barre d'authentification -->
    <div id="auth-bar" class="auth-bar">
        <div class="container auth-content">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <span id="user-email">utilisateur@exemple.com</span>
                <span id="admin-badge" class="admin-badge" style="display: none;">
                    <i class="fas fa-crown"></i> Administrateur
                </span>
            </div>
            <div>
                <button class="btn btn-sm btn-warning" id="backup-btn">
                    <i class="fas fa-download"></i>
                    Sauvegarder
                </button>
                <button class="btn btn-sm btn-danger" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    D√©connexion
                </button>
            </div>
        </div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-piggy-bank"></i>
                    Gestion des Cotisations
                </div>
                <nav>
                    <ul>
                        <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> Tableau de bord</a></li>
                        <li><a href="eleves.html" class="active"><i class="fas fa-users"></i> √âl√®ves</a></li>
                        <li><a href="cotisations.html"><i class="fas fa-hand-holding-usd"></i> Cotisations</a></li>
                        <li><a href="recherche.html"><i class="fas fa-search"></i> Recherche</a></li>
                        <li><a href="depenses.html"><i class="fas fa-receipt"></i> D√©penses</a></li>
                        <li><a href="resume.html"><i class="fas fa-chart-bar"></i> R√©sum√©</a></li>
                        <li class="auth-required"><a href="admin.html"><i class="fas fa-cog"></i> Administration</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-users"></i>
                Gestion des √©l√®ves
            </div>
            <button class="btn btn-primary" id="add-student-btn">
                <i class="fas fa-user-plus"></i>
                Ajouter un √©l√®ve
            </button>
        </div>

        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Date d'inscription</th>
                        <th>Cotisations pay√©es</th>
                        <th>Derni√®re cotisation</th>
                        <th class="auth-required">Actions</th>
                    </tr>
                </thead>
                <tbody id="students-list">
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-user-friends"></i>
                            <h3>Aucun √©l√®ve enregistr√©</h3>
                            <p>Ajoutez des √©l√®ves pour commencer √† g√©rer les cotisations</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal d'ajout d'√©l√®ve -->
    <div id="student-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Ajouter un √©l√®ve</h2>
                <span class="close">&times;</span>
            </div>
            <form id="student-form">
                <div class="form-group">
                    <label for="student-firstname"><i class="fas fa-user"></i> Pr√©nom</label>
                    <input type="text" id="student-firstname" required placeholder="Entrez le pr√©nom">
                </div>
                <div class="form-group">
                    <label for="student-lastname"><i class="fas fa-user"></i> Nom</label>
                    <input type="text" id="student-lastname" required placeholder="Entrez le nom">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i>
                    Enregistrer l'√©l√®ve
                </button>
            </form>
        </div>
    </div>

    <script src="js/firebase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/functions.js"></script>
    <script>
        console.log('üöÄ Chargement page √©l√®ves...');

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ Page √©l√®ves initialis√©e');
            
            try {
                // V√©rifier l'authentification
                await requireAuth();
                console.log('‚úÖ Authentification v√©rifi√©e');
                
                // Charger les donn√©es
                await loadStudents();
                await loadContributions();
                console.log('‚úÖ Donn√©es charg√©es');
                
                displayStudents();
                console.log('‚úÖ Liste des √©l√®ves affich√©e');
                
            } catch (error) {
                console.error('‚ùå Erreur initialisation:', error);
                return;
            }
            
            // √âv√©nement du bouton "Ajouter un √©l√®ve"
            const addStudentBtn = document.getElementById('add-student-btn');
            if (addStudentBtn) {
                addStudentBtn.addEventListener('click', function() {
                    console.log('üìù Clic bouton "Ajouter un √©l√®ve"');
                    document.getElementById('student-modal').style.display = 'flex';
                    
                    // Focus sur le premier champ
                    setTimeout(() => {
                        document.getElementById('student-firstname').focus();
                    }, 100);
                });
            } else {
                console.error('‚ùå Bouton "add-student-btn" non trouv√©');
            }
            
            // Formulaire d'ajout d'√©l√®ve
            const studentForm = document.getElementById('student-form');
            if (studentForm) {
                studentForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('üìù Soumission formulaire √©l√®ve');
                    
                    const firstName = document.getElementById('student-firstname').value.trim();
                    const lastName = document.getElementById('student-lastname').value.trim();
                    
                    if (!firstName || !lastName) {
                        showNotification('Veuillez remplir tous les champs', 'error');
                        return;
                    }
                    
                    // V√©rifier si l'√©l√®ve existe d√©j√†
                    const existingStudent = students.find(s => 
                        s.firstName.toLowerCase() === firstName.toLowerCase() && 
                        s.lastName.toLowerCase() === lastName.toLowerCase()
                    );
                    
                    if (existingStudent) {
                        showNotification('Cet √©l√®ve existe d√©j√†', 'error');
                        return;
                    }
                    
                    try {
                        console.log('üë§ Ajout √©l√®ve:', firstName, lastName);
                        await addStudent({
                            firstName: firstName,
                            lastName: lastName,
                            registrationDate: new Date().toISOString().split('T')[0]
                        });
                        
                        document.getElementById('student-modal').style.display = 'none';
                        this.reset();
                        
                        // Recharger les donn√©es
                        await loadStudents();
                        displayStudents();
                        
                    } catch (error) {
                        console.error('‚ùå Erreur ajout √©l√®ve:', error);
                        // L'erreur est d√©j√† g√©r√©e dans addStudent()
                    }
                });
            } else {
                console.error('‚ùå Formulaire "student-form" non trouv√©');
            }
            
            // Fermer les modals
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    console.log('‚ùå Fermeture modal');
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    console.log('‚ùå Fermeture modal (clic ext√©rieur)');
                    e.target.style.display = 'none';
                }
            });

            // Configurer le bouton de d√©connexion
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.onclick = logout;
            }
        });
        
        // Afficher la liste des √©l√®ves
        function displayStudents() {
            const container = document.getElementById('students-list');
            if (!container) {
                console.error('‚ùå Container "students-list" non trouv√©');
                return;
            }
            
            if (students.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-user-friends"></i>
                            <h3>Aucun √©l√®ve enregistr√©</h3>
                            <p>Ajoutez des √©l√®ves pour commencer √† g√©rer les cotisations</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            students.sort((a, b) => a.lastName.localeCompare(b.lastName))
                   .forEach(student => {
                const studentContributions = contributions.filter(c => c.studentId === student.id);
                const totalPaid = studentContributions.reduce((sum, c) => sum + c.amount, 0);
                const lastContribution = studentContributions.length > 0 
                    ? formatDate(studentContributions[studentContributions.length - 1].date)
                    : 'Aucune';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${student.firstName} ${student.lastName}</strong></td>
                    <td>${formatDate(student.registrationDate)}</td>
                    <td>${formatCurrency(totalPaid)}</td>
                    <td>${lastContribution}</td>
                    <td class="auth-required">
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.id}')">
                            <i class="fas fa-trash"></i>
                            Supprimer
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });

            console.log(`‚úÖ ${students.length} √©l√®ves affich√©s`);
        }
        
        // Supprimer un √©l√®ve
        async function deleteStudent(studentId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet √©l√®ve ? Toutes ses cotisations seront √©galement supprim√©es.')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Suppression √©l√®ve:', studentId);
                
                // Supprimer d'abord toutes ses cotisations
                const contributionsSnapshot = await db.collection('contributions')
                    .where('studentId', '==', studentId)
                    .get();
                
                const deletePromises = contributionsSnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);
                
                // Puis supprimer l'√©l√®ve
                await db.collection('students').doc(studentId).delete();
                
                showNotification('√âl√®ve supprim√© avec succ√®s');
                
                // Recharger les donn√©es
                await loadStudents();
                await loadContributions();
                displayStudents();
                
            } catch (error) {
                console.error('‚ùå Erreur suppression √©l√®ve:', error);
                showNotification('Erreur lors de la suppression', 'error');
            }
        }
    </script>
</body>
</html>