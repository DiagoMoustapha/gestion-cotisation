<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - Gestion des Cotisations</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .login-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-container {
            width: 100%;
            max-width: 400px;
        }
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
        }
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--dark);
        }
        .login-title i {
            font-size: 50px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        .login-title h1 {
            margin-bottom: 10px;
            font-size: 24px;
        }
        .login-title p {
            color: var(--gray);
            font-size: 14px;
        }
    </style>
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <div class="login-title">
                <i class="fas fa-piggy-bank"></i>
                <h1>Gestion des Cotisations</h1>
                <p>Connectez-vous pour acc√©der √† l'application</p>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="login-email" required placeholder="votre@email.com" value="test@example.com">
                </div>
                <div class="form-group">
                    <label for="login-password"><i class="fas fa-lock"></i> Mot de passe</label>
                    <input type="password" id="login-password" required placeholder="Votre mot de passe" value="123456">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i>
                    Se connecter
                </button>
            </form>
            
            <div style="margin-top: 20px; text-align: center;">
                <p style="color: var(--gray); margin-bottom: 15px; font-size: 14px;">Premi√®re utilisation ?</p>
                <button type="button" class="btn btn-secondary" id="show-register" style="width: 100%;">
                    <i class="fas fa-user-plus"></i>
                    Cr√©er un compte administrateur
                </button>
            </div>
        </div>
    </div>

    <!-- Modal d'inscription -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Cr√©er un compte administrateur</h2>
                <span class="close">&times;</span>
            </div>
            <form id="register-form">
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required placeholder="email@exemple.com">
                </div>
                <div class="form-group">
                    <label for="register-password">Mot de passe (min. 6 caract√®res)</label>
                    <input type="password" id="register-password" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="register-confirm">Confirmer le mot de passe</label>
                    <input type="password" id="register-confirm" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-user-plus"></i>
                    Cr√©er le compte administrateur
                </button>
            </form>
        </div>
    </div>

    <script src="js/firebase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/functions.js"></script>
    <script>
        console.log('üöÄ Initialisation page login...');

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ Page login charg√©e');
            
            // V√©rifier si l'utilisateur est d√©j√† connect√©
            if (auth.currentUser) {
                console.log('‚úÖ Utilisateur d√©j√† connect√©, redirection...');
                window.location.href = 'index.html';
                return;
            }

            // Formulaire de connexion
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('üìù Soumission formulaire connexion');
                    
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    
                    if (!email || !password) {
                        showNotification('Veuillez remplir tous les champs', 'error');
                        return;
                    }

                    try {
                        console.log('üîê Tentative de connexion:', email);
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        console.log('‚úÖ Connexion r√©ussie:', userCredential.user.email);
                        
                        showNotification('Connexion r√©ussie ! Redirection...', 'success');
                        
                        // Rediriger vers le tableau de bord apr√®s connexion
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1000);
                        
                    } catch (error) {
                        console.error('‚ùå Erreur connexion:', error);
                        let errorMessage = 'Erreur de connexion';
                        
                        switch (error.code) {
                            case 'auth/user-not-found':
                                errorMessage = 'Aucun compte trouv√© avec cet email';
                                break;
                            case 'auth/wrong-password':
                                errorMessage = 'Mot de passe incorrect';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'Email invalide';
                                break;
                            case 'auth/too-many-requests':
                                errorMessage = 'Trop de tentatives. R√©essayez plus tard';
                                break;
                            default:
                                errorMessage = error.message;
                        }
                        
                        showNotification(errorMessage, 'error');
                    }
                });
            }
            
            // Afficher le modal d'inscription
            const showRegisterBtn = document.getElementById('show-register');
            if (showRegisterBtn) {
                showRegisterBtn.addEventListener('click', () => {
                    console.log('üìù Ouverture modal inscription');
                    document.getElementById('register-modal').style.display = 'flex';
                });
            }
            
            // Formulaire d'inscription
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('üìù Soumission formulaire inscription');
                    
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    const confirm = document.getElementById('register-confirm').value;
                    
                    if (!email || !password || !confirm) {
                        showNotification('Veuillez remplir tous les champs', 'error');
                        return;
                    }
                    
                    if (password !== confirm) {
                        showNotification('Les mots de passe ne correspondent pas', 'error');
                        return;
                    }
                    
                    if (password.length < 6) {
                        showNotification('Le mot de passe doit faire au moins 6 caract√®res', 'error');
                        return;
                    }

                    try {
                        console.log('üë§ Cr√©ation compte:', email);
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        
                        console.log('‚úÖ Compte cr√©√©:', user.email);
                        
                        // Ajouter comme administrateur
                        await db.collection('admins').doc(user.uid).set({
                            email: email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            isActive: true
                        });
                        
                        console.log('‚úÖ Droits admin accord√©s');
                        
                        showNotification('Compte administrateur cr√©√© avec succ√®s !', 'success');
                        document.getElementById('register-modal').style.display = 'none';
                        registerForm.reset();
                        
                        // Connexion automatique
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1500);
                        
                    } catch (error) {
                        console.error('‚ùå Erreur cr√©ation compte:', error);
                        let errorMessage = 'Erreur cr√©ation compte';
                        
                        switch (error.code) {
                            case 'auth/email-already-in-use':
                                errorMessage = 'Un compte existe d√©j√† avec cet email';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'Email invalide';
                                break;
                            case 'auth/weak-password':
                                errorMessage = 'Le mot de passe est trop faible';
                                break;
                            default:
                                errorMessage = error.message;
                        }
                        
                        showNotification(errorMessage, 'error');
                    }
                });
            }
            
            // Fermer les modals
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    console.log('‚ùå Fermeture modal');
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    console.log('‚ùå Fermeture modal (clic ext√©rieur)');
                    e.target.style.display = 'none';
                }
            });

            // Ajouter des valeurs de test pour faciliter les tests
            console.log('üéØ Valeurs de test pr√©-remplies pour faciliter les tests');
        });
    </script>
</body>
</html>