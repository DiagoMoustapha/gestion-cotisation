<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche - Gestion des Cotisations</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Barre d'authentification -->
    <div id="auth-bar" class="auth-bar">
        <div class="container auth-content">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <span id="user-email">utilisateur@exemple.com</span>
                <span id="admin-badge" class="admin-badge" style="display: none;">
                    <i class="fas fa-crown"></i> Administrateur
                </span>
            </div>
            <div>
                <button class="btn btn-sm btn-warning" id="backup-btn">
                    <i class="fas fa-download"></i>
                    Sauvegarder
                </button>
                <button class="btn btn-sm btn-danger" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Déconnexion
                </button>
            </div>
        </div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-piggy-bank"></i>
                    Gestion des Cotisations
                </div>
                <nav>
                    <ul>
                        <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> Tableau de bord</a></li>
                        <li><a href="eleves.html"><i class="fas fa-users"></i> Élèves</a></li>
                        <li><a href="cotisations.html"><i class="fas fa-hand-holding-usd"></i> Cotisations</a></li>
                        <li><a href="recherche.html" class="active"><i class="fas fa-search"></i> Recherche</a></li>
                        <li><a href="depenses.html"><i class="fas fa-receipt"></i> Dépenses</a></li>
                        <li><a href="resume.html"><i class="fas fa-chart-bar"></i> Résumé</a></li>
                        <li class="auth-required"><a href="admin.html"><i class="fas fa-cog"></i> Administration</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-search"></i>
                    Recherche par semaine
                </div>
            </div>
            <div class="search-week">
                <input type="week" id="week-selector" placeholder="Sélectionnez une semaine">
                <button class="btn btn-primary" id="search-week-btn">
                    <i class="fas fa-search"></i>
                    Rechercher
                </button>
            </div>
            
            <div id="week-results">
                <div class="empty-state">
                    <i class="fas fa-calendar-alt"></i>
                    <h3>Sélectionnez une semaine</h3>
                    <p>Choisissez une semaine pour voir les détails des cotisations</p>
                </div>
            </div>
        </div>
    </div>

    <script src="js/firebase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/functions.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Vérifier l'authentification
            await requireAuth();
            
            // Charger les données
            await loadStudents();
            await loadContributions();
            
            // Événement de recherche
            document.getElementById('search-week-btn').addEventListener('click', searchWeek);
            
            // Recherche automatique quand la semaine change
            document.getElementById('week-selector').addEventListener('change', searchWeek);
        });
        
        // Recherche par semaine
        function searchWeek() {
            const weekInput = document.getElementById('week-selector').value;
            const resultsContainer = document.getElementById('week-results');
            
            if (!weekInput) {
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>Sélectionnez une semaine</h3>
                        <p>Choisissez une semaine pour voir les détails des cotisations</p>
                    </div>
                `;
                return;
            }
            
            // Convertir l'entrée semaine (format YYYY-WXX) en date de début de semaine
            const [year, weekNum] = weekInput.split('-W');
            const weekStart = getDateFromWeek(year, weekNum);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            // Filtrer les cotisations de cette semaine
            const weekContributions = contributions.filter(c => c.week === weekStart.toISOString().split('T')[0]);
            const totalAmount = weekContributions.reduce((sum, c) => sum + c.amount, 0);
            const paidStudents = [...new Set(weekContributions.map(c => c.studentId))];
            const pendingStudents = students.filter(s => !paidStudents.includes(s.id));
            
            let resultsHTML = `
                <div class="week-details">
                    <h3 style="margin-bottom: 20px; color: var(--dark);">Semaine du ${formatDate(weekStart)} au ${formatDate(weekEnd)}</h3>
                    
                    <div class="week-stats">
                        <div class="week-stat-card">
                            <div class="week-stat-label">Total collecté</div>
                            <div class="week-stat-value">${formatCurrency(totalAmount)}</div>
                        </div>
                        <div class="week-stat-card">
                            <div class="week-stat-label">Élèves ayant payé</div>
                            <div class="week-stat-value">${paidStudents.length}/${students.length}</div>
                        </div>
                        <div class="week-stat-card">
                            <div class="week-stat-label">Taux de participation</div>
                            <div class="week-stat-value">${Math.round((paidStudents.length / students.length) * 100)}%</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-list"></i>
                                Détail des cotisations
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Élève</th>
                                    <th>Date</th>
                                    <th>Montant</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Ajouter les élèves ayant payé
            students.sort((a, b) => a.lastName.localeCompare(b.lastName))
                   .forEach(student => {
                const studentContribution = weekContributions.find(c => c.studentId === student.id);
                if (studentContribution) {
                    resultsHTML += `
                        <tr>
                            <td><strong>${student.firstName} ${student.lastName}</strong></td>
                            <td>${formatDate(studentContribution.date)}</td>
                            <td>${formatCurrency(studentContribution.amount)}</td>
                            <td><span class="status-paid">Payé</span></td>
                        </tr>
                    `;
                } else {
                    resultsHTML += `
                        <tr>
                            <td><strong>${student.firstName} ${student.lastName}</strong></td>
                            <td>-</td>
                            <td>-</td>
                            <td><span class="status-pending">En attente</span></td>
                        </tr>
                    `;
                }
            });
            
            resultsHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            resultsContainer.innerHTML = resultsHTML;
        }
        
        // Obtenir la date de début de semaine à partir de l'année et du numéro de semaine
        function getDateFromWeek(year, week) {
            const date = new Date(year, 0, 1 + (week - 1) * 7);
            const dayOfWeek = date.getDay();
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            date.setDate(date.getDate() + diffToMonday);
            return date;
        }
    </script>

    <style>
        .search-week {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }
        
        .search-week input {
            flex: 1;
            max-width: 300px;
        }
        
        .week-details {
            margin-top: 25px;
        }
        
        .week-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .week-stat-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            transition: transform 0.3s;
        }
        
        .week-stat-card:hover {
            transform: translateY(-5px);
        }
        
        .week-stat-value {
            font-size: 28px;
            font-weight: bold;
            margin: 15px 0;
            color: var(--primary);
        }
        
        .week-stat-label {
            font-size: 14px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 768px) {
            .search-week {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-week input {
                max-width: 100%;
            }
            
            .week-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>